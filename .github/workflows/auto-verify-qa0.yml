# Auto-verify QA-0 issues when CI passes
# QA-0 = CI-only verification, no human review needed

name: Auto-Verify QA-0

on:
  # Trigger when any workflow completes (catches CI completion)
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  auto-verify:
    # Only run if the triggering workflow succeeded
    if: github.event.workflow_run.conclusion == 'success'
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Get PR and issue info
        id: info
        uses: actions/github-script@v7
        with:
          script: |
            const workflowRun = context.payload.workflow_run;
            console.log('Workflow run:', workflowRun.name);
            console.log('Conclusion:', workflowRun.conclusion);
            console.log('Head SHA:', workflowRun.head_sha);
            
            // Get PRs associated with this workflow run
            const prs = workflowRun.pull_requests || [];
            console.log('Associated PRs:', prs.length);
            
            if (prs.length === 0) {
              console.log('No PRs associated with this workflow run');
              core.setOutput('has_pr', 'false');
              return;
            }
            
            const prNumber = prs[0].number;
            const headSha = workflowRun.head_sha;
            
            // Get full PR details including body
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            // Find linked issues from PR body (Closes #X, Fixes #X, etc.)
            const body = pr.body || '';
            const issueMatches = body.match(/(?:closes|fixes|resolves)\s+#(\d+)/gi) || [];
            const issueNumbers = issueMatches.map(m => parseInt(m.match(/\d+/)[0]));
            
            console.log('PR #' + prNumber);
            console.log('Linked issues:', issueNumbers.join(', ') || 'none');
            
            core.setOutput('has_pr', 'true');
            core.setOutput('pr_number', prNumber.toString());
            core.setOutput('head_sha', headSha);
            core.setOutput('issue_numbers', JSON.stringify(issueNumbers));

      - name: Auto-verify QA-0 issues
        if: steps.info.outputs.has_pr == 'true' && steps.info.outputs.issue_numbers != '[]'
        uses: actions/github-script@v7
        env:
          CRANE_RELAY_TOKEN: ${{ secrets.CRANE_RELAY_TOKEN }}
        with:
          script: |
            const issueNumbers = JSON.parse('${{ steps.info.outputs.issue_numbers }}');
            const prNumber = parseInt('${{ steps.info.outputs.pr_number }}');
            const headSha = '${{ steps.info.outputs.head_sha }}';
            const repo = `${context.repo.owner}/${context.repo.repo}`;
            
            console.log('Checking issues:', issueNumbers.join(', '));
            
            for (const issueNumber of issueNumbers) {
              // Get issue details
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              
              const labels = issue.labels.map(l => l.name);
              console.log(`Issue #${issueNumber} labels:`, labels.join(', '));
              
              // Check for qa-grade:0
              if (!labels.includes('qa-grade:0')) {
                console.log(`Issue #${issueNumber} is not QA-0, skipping`);
                continue;
              }
              
              // Check for status:qa
              if (!labels.includes('status:qa')) {
                console.log(`Issue #${issueNumber} is not in status:qa, skipping`);
                continue;
              }
              
              console.log(`Issue #${issueNumber} qualifies for auto-verify`);
              
              // Submit PASS via Crane Relay V2
              const eventId = `auto-qa0-${issueNumber}-${Date.now()}`;
              
              try {
                const response = await fetch('https://crane-relay.automation-ab6.workers.dev/v2/events', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-Relay-Key': process.env.CRANE_RELAY_TOKEN
                  },
                  body: JSON.stringify({
                    event_id: eventId,
                    repo: repo,
                    issue_number: issueNumber,
                    role: 'QA',
                    agent: 'github-actions-auto-qa0',
                    event_type: 'qa.result_submitted',
                    environment: 'dev',
                    overall_verdict: 'PASS',
                    summary: 'Auto-verified: CI passed, QA-0 grade (no human review required)',
                    build: {
                      pr: prNumber,
                      commit_sha: headSha
                    },
                    scope_results: [
                      { id: 'CI', status: 'PASS', notes: 'All CI checks passed' }
                    ]
                  })
                });
                
                const result = await response.json();
                
                if (result.ok) {
                  console.log(`✅ Auto-verified issue #${issueNumber}`);
                } else {
                  console.log(`❌ Relay error for issue #${issueNumber}:`, JSON.stringify(result));
                }
              } catch (error) {
                console.log(`❌ Failed to call relay for issue #${issueNumber}:`, error.message);
              }
            }

